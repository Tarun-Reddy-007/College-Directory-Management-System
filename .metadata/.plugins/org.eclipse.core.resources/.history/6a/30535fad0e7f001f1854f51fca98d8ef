package com.example.collegedirectory.services;

import com.example.collegedirectory.entities.Department;
import com.example.collegedirectory.entities.Enrollment;
import com.example.collegedirectory.entities.StudentProfile;
import com.example.collegedirectory.repositories.CourseRepository;
import com.example.collegedirectory.repositories.DepartmentRepository;
import com.example.collegedirectory.repositories.EnrollmentRepository;
import com.example.collegedirectory.repositories.StudentProfileRepository;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class StudentProfileService {

    @Autowired
    private StudentProfileRepository studentProfileRepository;
    
    @Autowired
    private DepartmentRepository departmentRepository;
    
    @Autowired
    private EnrollmentRepository enrollmentRepository; // Add this
    @Autowired
    private CourseRepository courseRepository;
    
    public StudentProfile findById(Long id) {
        return studentProfileRepository.findById(id).orElse(null); // Return null if not found
    }
    
    public Map<String, Object> getStudentAcademicDetails(Long userId) {
        // Retrieve student profile by userId
        StudentProfile studentProfile = studentProfileRepository.findByUserId(userId);
        if (studentProfile == null) {
            throw new RuntimeException("Student not found.");
        }
        System.out.println("Student: " + studentProfile);

        // Retrieve the department from the student profile
        Department department = studentProfile.getDepartment();
        if (department == null) {
            throw new RuntimeException("Department not found.");
        }
        System.out.println("Department: " + department);

        // Prepare response data
        Map<String, Object> academicDetails = new HashMap<>();
        academicDetails.put("year", studentProfile.getYear());
        academicDetails.put("department", department.getName());

        return academicDetails;
    }

    public List<Map<String, String>> getEnrolledCourses(Long userId) {
        // Retrieve student profile by userId
        StudentProfile studentProfile = studentProfileRepository.findByUserId(userId);
        if (studentProfile == null) {
            throw new RuntimeException("Student not found.");
        }

        // Retrieve all enrollments for the student
        List<Enrollment> enrollments = enrollmentRepository.findByStudent(studentProfile);
        
        // Fetch course details
        return enrollments.stream()
                .map(enrollment -> {
                    Course course = enrollment.getCourse();
                    return Map.of(
                            "title", course.getTitle(),
                            "description", course.getDescription()
                    );
                })
                .collect(Collectors.toList());
    }

}
